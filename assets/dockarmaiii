#!/bin/bash

main() {
  # perform pre-install configuration
  # source /etc/myvars
  initial_checks

  if [[ $DRYRUN = true ]]; then
    echo 'This is a dry county, Son!'
  else
    startup
  fi
}

initial_checks() {
  # check to see FS mounts are writable
  fs_check /data/testfile
  fs_check /home/steam/testfile

  if [ ! -f /home/steam/steamer.txt ]
    then
      do_steamer_config
  fi

  if [[ $BUILD_ENABLED = true ]]; then
    if [[ $FORCEUPDATE = true ]] || [ ! -f /data/dockarmaiii_update_date ]
      then
        do_app_update
    fi

    if [[ $WASTELAND_ENABLED = true ]]; then
      do_wasteland_dl
    fi

    if [[ $OVERWATCH_ENABLED = true ]]; then
      do_ace_dl
      do_overwatch_dl
    fi
  fi
}

fs_check() {
  if [ ! -f $1 ]
    then
      FS_CHECK=0
      echo "waiting on $1 to be writable"
      while [ ! $FS_CHECK = 'success' ]
      do
        echo 'success' |tee $1 || true
        FS_CHECK=$(cat $1 ) || FS_CHECK=0
      done
      echo "File system check was $FS_CHECK"
      rm $1
  else
    echo "$1 exists already"
  fi
}

startup() {
  # perform post-install configuration
  source /assets/config.sh
  cd /data
  while [ 1 ]
  do
    echo "./arma3server $CMDSTRING"
    eval ./arma3server $CMDSTRING
    #sleep 1800
    echo restarting
    sleep 3
  done

}

do_app_update() {
  echo 'data install'
  sleep 3
  date -I > /data/dockarmaiii_start_data
  cat /data/dockarmaiii_start_data
  mkdir -p /data/arma3
  cd /opt/steamer
  ./steamcmd.sh +runscript /home/steam/steamer.txt
  cd /data
  rm -Rf /data/mpmissions
  mkdir -p /home/steam/mpmissions
  ln -s /home/steam/mpmissions
  rm /data/dockarmaiii_start_data
  date -I > /data/dockarmaiii_update_date
  sudo chown -R steam:steam /data
}

do_steamer_config() {
  # allow nfs to settle
  echo 'configuration'
  sleep 3
  date -I > /home/steam/dockarmaiii_start_config
  cat /home/steam/dockarmaiii_start_config

  cp /assets/steamer.txt /home/steam/
  cd /home/steam
  #ln -s '/home/steam/Steam/steamapps/common/Arma 3 Server' arma3
  sed -i "s/REPLACEME_USERNAME/$STEAM_USERNAME/" steamer.txt
  sed -i "s/REPLACEME_PASSWORD/$STEAM_PASSWORD/" steamer.txt
  sed -i "s/REPLACEME_GID/$STEAM_GID/" steamer.txt
  sudo chown -R steam:steam /home/steam
  rm /home/steam/dockarmaiii_start_config
  date -I > /home/steam/dockarmaiii_update_config
}

do_wasteland_dl() {
  if [ ! -f /data/.wasteland.dl ]
    then
      echo "WASTELAND_DL"
      cd /home/steam/mpmissions
      wget -c -q https://github.com/Thalhalla/ArmA3_Wasteland.Altis/raw/dev/release/ArmA3_Wasteland.Altis.pbo
      date -I > /data/.wasteland.dl
  fi
}

do_overwatch_dl() {
  if [ ! -f /data/.overwatch.dl ]
    then
      echo "OVERWATCH_DL"
      ${OVERTHROW_VERSION:=0.7.5.1}
      TMP=$(mktemp -d)
      cd $TMP
      wget -cq https://github.com/ArmaOverthrow/Overthrow/archive/$OVERTHROW_VERSION.zip
      unzip $OVERTHROW_VERSION.zip
      mkdir -p '/data/mods'
      mv Overthrow-$OVERTHROW_VERSION  '/data/mods/@Overthrow'
      cd
      rm -Rf $TMP
      date -I > /data/.overwatch.dl
  fi
}

do_ace_dl() {
  if [ ! -f /data/.ace.dl ]
    then
      echo "ACE_DL"
      ${ACE_VERSION:=3.10.1}
      ACE_FILE=ace3_$ACE_VERSION.zip
      TMP=$(mktemp -d)
      cd $TMP
      wget -cq https://github.com/acemod/ACE3/releases/download/v$ACE_VERSION/$ACE_FILE
      unzip $ACE_FILE
      mkdir -p '/data/mods'
      mv '@ace' '/data/mods/@ace'
      cd
      rm -Rf $TMP
      date -I > /data/.ace.dl
  fi
}

main "$@"
